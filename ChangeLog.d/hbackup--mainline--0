# do not edit -- automatically generated by arch changelog
# arch-tag: automatic-ChangeLog--rjk@greenend.org.uk--2004/hbackup--mainline--0
#

2007-01-28 11:21:24 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-82

    Summary:
      Filename encoding translation
    Revision:
      hbackup--mainline--0--patch-82

    New --from-encoding, --to-encoding options and Recode class provide
    filename translation, useful for cross-restores (e.g. Windows filesystem
    using C1252 to Mac using UTF-8).
    
    * nhbackup.cc: --from-encoding, --to-encoding options.
    * restore.cc: --from-encoding, --to-encoding options.
    * recode.cc: Wrapper class for string encoding conversion.
    
    * recodetest.cc: Test rig for Recode class.
    
    * hbackup.1: Document --no-permissions
    * hbackup.1: Document --from-encoding, --to-encoding
    * hbackup.1: New section on cross-restores.

    new files:
     recode.cc recodetest.cc

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile TODO globals.cc
     hbackup.1 local.cc makedefs.unix nhbackup.cc nhbackup.h
     restore.cc sftp.cc


2007-01-27 12:39:31 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-81

    Summary:
      Remove temporary directories
    Revision:
      hbackup--mainline--0--patch-81

    * nhbackup.h: Filesystem classes offer remove() instead of unlink(),
      i.e. will remove directories as well as everything else.  (Stupid
      distinction.)
    * nhbackup.h: SFTP errors carry the SFTP status around with them.
    * local.cc: Offer remove() instead of unlink(), using remove(3).
    * sftp.cc: Offer remove() instead of (in fact as well as) unlink(), by
      spotting failures that might be a result of unlinking a directory and
      retrying.
    
    * restore.cc: Use remove() instead of unlink().
    * cleanup.cc: Use remove() instead of unlink().
    * verify.cc: Use remove() instead of unlink().

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc local.cc
     nhbackup.h restore.cc sftp.cc verify.cc


2007-01-27 11:45:26 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-80

    Summary:
      --no-permissions, restore verbosity and new Python fixes
    Revision:
      hbackup--mainline--0--patch-80

    * hbackup: convert timestamps to ints.  This throws away subsecond
      timestamp information but is necessary for the time being for restores
      to work.
    
    * globals.cc: total_hardlinks counter and permissions flag
    
    * nhbackup.cc: Add --no-permissions option to suppress permissions
      changes in restore, when restoring for file content rather than to
      restore an exact system image.
    
    * nhbackup.cc: If --restore --verbose, produce a report of different file
      types restored.
    
    * restore.cc: Count up different file types as they are restored, and
      report the main divisions of activity.
    
    * restore.cc: If --no-permissions, all restore files get default
      permissions and ownership.  Timestamps are still restored however.

    modified files:
     ChangeLog.d/hbackup--mainline--0 globals.cc hbackup
     nhbackup.cc nhbackup.h restore.cc


2006-11-19 17:19:15 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-79

    Summary:
      Chymax stuff
    Revision:
      hbackup--mainline--0--patch-79

    * hbackup.sh: Make directory for chymax.
    * rbackup.chymax: chymax backup script copied from kakajou's
    * backup.chymax: chymax backup script copied from kakajou's

    new files:
     backup.chymax rbackup.chymax

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile hbackup.sh


2006-11-19 17:15:27 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-78

    Summary:
      Missing virtual destructor
    Revision:
      hbackup--mainline--0--patch-78

    * filesystem.cc: Add a virtual destructor as demanded by latest compiler.

    new files:
     filesystem.cc

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile nhbackup.h


2006-11-11 11:09:39 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-77

    Summary:
      Use right SFTP server to create remote directories
    Revision:
      hbackup--mainline--0--patch-77

    * hbackup.sh: Use right SFTP server to create remote directories.
    * rbackup.kakajou: Specify right SFTP server
    * rbackup.lyonesse: Specify right SFTP server

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup.sh rbackup.kakajou
     rbackup.lyonesse


2006-11-11 10:44:03 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-76

    Summary:
      mkdir -p again
    Revision:
      hbackup--mainline--0--patch-76

    * hbackup.sh: mkdir -p is not expected to fail even if the directory
      exists, so don't throw away errors.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup.sh


2006-11-10 18:06:01 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-75

    Summary:
      Fix creation of remote directories.
    Revision:
      hbackup--mainline--0--patch-75

    * hbackup.sh: remote mkdir is -p too.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup.sh


2006-11-09 21:16:11 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-74

    Summary:
      Simple filename compression.
    Revision:
      hbackup--mainline--0--patch-74

    * backup.cc: Compress filenames by using ./ to mean "the last directory
      you saw".
    * restore.cc: Honor compressed filenames.
    * hbackup: Honor compressed filenames.
    * utils.cc: escape ';' in url-encoded strings, python's url-decoder
      splits on it.
    * tests: Test nhbackup output against hbackup and construct a tree to
      exercise the filename compression a bit better.
    * hbackup.1: Document compressed filenames.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc hbackup hbackup.1
     restore.cc tests utils.cc


2006-11-09 20:33:47 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-73

    Summary:
      More aggressive use of data=
    Revision:
      hbackup--mainline--0--patch-73

    * backup.cc: Increase the upper bound for files stored by content to 256,
      and add a comment discussing the tradeoffs.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc


2006-11-09 20:14:51 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-72

    Summary:
      Reverse host/date order
    Revision:
      hbackup--mainline--0--patch-72

    * hbackup.sh: Make backup directory be HOST/DATE not DATE/HOST

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup.sh


2006-10-22 10:23:33 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-71

    Summary:
      Tidying up
    Revision:
      hbackup--mainline--0--patch-71

    * rbackup.lyonesse: remove obsolete comment

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-10-22 10:19:55 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-70

    Summary:
      Fix exclusions
    Revision:
      hbackup--mainline--0--patch-70

    * backup.cc: --exclude works against the name relative to the root, not
      the full path (which might be wacky due to snapshotting etc).
    * backup.sfere: Kill some more tmp/cache directories in /var.
    * rbackup.lyonesse: Kill some more tmp/cache directories in /var.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc backup.sfere
     rbackup.lyonesse


2006-09-23 18:14:44 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-69

    Summary:
      remove debug!
    Revision:
      hbackup--mainline--0--patch-69

    * utils.cc: Remove debug code that crept in
    
    

    modified files:
     ChangeLog.d/hbackup--mainline--0 utils.cc


2006-09-23 18:12:40 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-68

    Summary:
      Pass back status from backup program
    Revision:
      hbackup--mainline--0--patch-68

    Missed a bit...

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.curator backup.kakajou
     backup.lyonesse backup.sfere hbackup.sh rbackup.kakajou
     rbackup.lyonesse rbackup.sfere utils.cc


2006-09-23 18:02:33 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-67

    Summary:
      Improved error reporting
    Revision:
      hbackup--mainline--0--patch-67

    * hbackup.sh: set $status nonzero on any failures.
    * *backup.HOSTNAME: exit $status
    
    My wrapper script now constructs a subject line to indicate success and
    failure so useful exit statuses are now required.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.curator backup.kakajou
     backup.lyonesse backup.sfere hbackup.sh rbackup.kakajou
     rbackup.lyonesse rbackup.sfere


2006-09-23 16:24:47 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-66

    Summary:
      Porting infrastructure
    Revision:
      hbackup--mainline--0--patch-66

    NB does not build for Windows yet, that's a long way off.
    
    * Makefile: Include per-platform makedefs.* files
    * nhbackup.h: Don't include UNIX-only headers on Windows.
    * makedefs.unix: Native make definitions
    * makedefs.mingw: Make definitions for crossbuild.

    new files:
     makedefs.mingw makedefs.unix

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile nhbackup.h
     {arch}/=tagging-method


2006-09-23 12:24:45 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-65

    Summary:
      Eliminate gcrypt dependency.
    Revision:
      hbackup--mainline--0--patch-65

    This is part of a plan to produce a Windows port.  The things that need
    doing are:
       - eliminate gcrypt dependency
       - build pcre for windows
       - parameterize makefile to work with mingw
       - eliminate or rewrite POSIX-dependent code
    And optionally:
       - produce whatever kind of build script VC++ requires
    
    This change only deals with the gcrypt elimination, by including a C SHA1
    implementation.
    
    * sha1.c: The SHA1 implementation from RFC3174.
    * Makefile: Run sha1test in 'make check'.
    * exceptions.cc: Understand sha1.h error codes.
    * hash.cc: Use sha1.h instead of gcrypt.
    * nhbackup.h: Use sha1.h instead of gcrypt.  It turns out that gcrypt
      includes a bunch of header files formerly forgotten, so add those too.
    * sha1test.c: SHA1 test rig from RFC3174, adapted to do the tests itself
      instead of relying on a human reading the output(!)
    
    Tested with 'make check' and by running a --verify over a pre-existing
    backup (--verify rehashes files found in the repo).

    new files:
     sha1.c sha1.h sha1test.c

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile exceptions.cc
     hash.cc nhbackup.h


2006-09-20 21:10:52 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-64

    Summary:
      disable /tsais backup
    Revision:
      hbackup--mainline--0--patch-64

    * rbackup.lyonesse: disable /tsais backup (bad fs, or bad linux driver?)

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-09-17 13:15:01 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-63

    Summary:
      Fix XP backups.
    Revision:
      hbackup--mainline--0--patch-63

    * rbackup.lyonesse: Don't back up invisible 'System Volume Information'
      on /tsais.

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-08-13 22:53:27 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-62

    Summary:
      More local policy
    Revision:
      hbackup--mainline--0--patch-62

    * rbackup.lyonesse: Ignore windows trash directory.

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-08-13 14:26:49 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-61

    Summary:
      Local policy.
    Revision:
      hbackup--mainline--0--patch-61

    * rbackup.lyonesse: exclude windows swapfile.

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-08-13 12:52:42 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-60

    Summary:
      Local policy again.
    Revision:
      hbackup--mainline--0--patch-60

    * rbackup.lyonesse: typo fix.

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-08-12 22:41:52 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-59

    Summary:
      Local policy
    Revision:
      hbackup--mainline--0--patch-59

    * rbackup.lyonesse: back up /tsais

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.lyonesse


2006-07-16 18:39:23 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-58

    Summary:
      More string:::reserve() calls.
    Revision:
      hbackup--mainline--0--patch-58

    * sftp.cc: string::reserve() calls with buffer size estimates.

    modified files:
     ChangeLog.d/hbackup--mainline--0 sftp.cc


2006-07-16 18:31:22 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-57

    Summary:
      More speedups.
    Revision:
      hbackup--mainline--0--patch-57

    * utils.cc: Faster urlencode().

    modified files:
     ChangeLog.d/hbackup--mainline--0 speedtest.cc utils.cc


2006-07-16 13:04:50 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-56

    Summary:
      Report bad input files in --cleanup.
    Revision:
      hbackup--mainline--0--patch-56

    * cleanup.cc: Report bad input files in a single list.

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc


2006-07-16 12:43:39 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-55

    Summary:
      Hash table stats reporting
    Revision:
      hbackup--mainline--0--patch-55

    * cleanup.cc: Dump hash table stats if --verbose.
    * hash.cc: HashSet::stats() dumps hash table stats
    * tests: --verbose for --cleanup to get stats

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc hash.cc nhbackup.h
     tests


2006-07-16 12:32:48 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-54

    Summary:
      Better BadIndexFile reporting.
    Revision:
      hbackup--mainline--0--patch-54

    * cleanup.cc: Tidier error message!

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc


2006-07-16 12:31:31 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-53

    Summary:
      Cope with truncated index files more gracefuly
    Revision:
      hbackup--mainline--0--patch-53

    * cleanup.cc: If we run into BadIndexFile report it but continue.

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc


2006-07-16 12:28:19 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-52

    Summary:
      Faster hexencode()
    Revision:
      hbackup--mainline--0--patch-52

    * utils.cc: ~50% speedup for hexencode() by pre-reserving buffer and
      using lookup table.

    modified files:
     ChangeLog.d/hbackup--mainline--0 speedtest.cc utils.cc


2006-07-16 12:23:36 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-51

    Summary:
      Faster URL-decoding still.
    Revision:
      hbackup--mainline--0--patch-51

    * utils.cc: pre-reserve space for urldecode().  50% speedup in
      parseIndexLine()!

    modified files:
     ChangeLog.d/hbackup--mainline--0 utils.cc


2006-07-16 12:20:57 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-50

    Summary:
      Lookup table for hex decoding
    Revision:
      hbackup--mainline--0--patch-50

    * utils.cc: Lookup table for hex conversion.
    * nhbackup.cc: Assert that assumptions are true.

    modified files:
     ChangeLog.d/hbackup--mainline--0 nhbackup.cc nhbackup.h
     utils.cc


2006-07-16 11:55:51 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-49

    Summary:
      More small speedups
    Revision:
      hbackup--mainline--0--patch-49

    * utils.cc: Reserve hexdecode() buffer once rather expanding as we go,
      and fish chars out of the input hex directly.
    
      Use operator[] in parseIndexLine() which as well as being a little
      faster (experimentally) is also clearer.

    modified files:
     ChangeLog.d/hbackup--mainline--0 utils.cc


2006-07-16 11:36:03 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-48

    Summary:
      Fast URL-decoding.
    Revision:
      hbackup--mainline--0--patch-48

    * utils.cc: Eliminate a pair of substring copies from readIndexLine.
      About a 10% speedup.  The index-scanning phase of --cleanup appears to
      be CPU-bound on my main backup platform so this should be worthwhile.
    
    * speedtest.cc: Simple speed testing infrastructure.

    new files:
     speedtest.cc

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile nhbackup.cc
     nhbackup.h utils.cc {arch}/=tagging-method


2006-07-15 12:50:11 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-47

    Summary:
      More subtle handling of bad index files.
    Revision:
      hbackup--mainline--0--patch-47

    * cleanup.cc: Check all files rather than failing after the first.  We
      collect all the file names in the interests of being able to list them
      conveneintly, though we don't actually produce the list yet.

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc


2006-07-15 12:45:57 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-46

    Summary:
      Correct url-encoding.
    Revision:
      hbackup--mainline--0--patch-46

    * utils.cc: Correct url-encoding of bytes > 127.  More specific reports
      when a bad hex string is encountered.

    modified files:
     ChangeLog.d/hbackup--mainline--0 utils.cc


2006-07-11 22:57:15 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-45

    Summary:
      Correct hashing of large files.
    Revision:
      hbackup--mainline--0--patch-45

    * hash.cc: Correct mmap-based hashing.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hash.cc


2006-07-11 18:38:41 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-44

    Summary:
      Correct --exclude.
    Revision:
      hbackup--mainline--0--patch-44

    * backup.sfere: correct --exclude for nhbackup
    * rbackup.kakajou: correct --exclude for nhbackup
    * rbackup.lyonesse: correct --exclude for nhbackup

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.sfere rbackup.kakajou
     rbackup.lyonesse


2006-07-09 13:44:17 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-43

    Summary:
      More tests
    Revision:
      hbackup--mainline--0--patch-43

    * tests: test cleanup with bogus names in the repo

    modified files:
     ChangeLog.d/hbackup--mainline--0 tests


2006-07-09 13:26:42 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-42

    Summary:
      Copyright notices + README + --version
    Revision:
      hbackup--mainline--0--patch-42

    * README: description.
    * nhbackup.cc: Add a --version option.
    * *.cc, *.h, hbackup: Add GPL comment.

    new files:
     README

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile backup.cc cleanup.cc
     exceptions.cc exclude.cc file.cc globals.cc hash.cc hbackup
     hbackup.1 local.cc nhbackup.cc nhbackup.h restore.cc sftp.cc
     utils.cc verify.cc


2006-07-09 11:34:17 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-41

    Summary:
      openssh.patch
    Revision:
      hbackup--mainline--0--patch-41

    * openssh.patch: diff to openssh's sftp server to bodge around rename
      problems.

    new files:
     .arch-ids/openssh.patch.id openssh.patch

    modified files:
     ChangeLog.d/hbackup--mainline--0

    new directories:
     .arch-ids


2006-07-09 11:31:12 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-40

    Summary:
      Build on Linux.
    Revision:
      hbackup--mainline--0--patch-40

    * nhbackup.cc: Missing include.
    * sftp.cc: Missing includes.

    modified files:
     ChangeLog.d/hbackup--mainline--0 nhbackup.cc sftp.cc


2006-07-09 11:28:59 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-39

    Summary:
      Use nhbackup more widely.
    Revision:
      hbackup--mainline--0--patch-39

    * rbackup.lyonesse: Use nhbackup and bodged SFTP server.
    * rbackup.kakajou: Use nhbackup and bodged SFTP server.

    modified files:
     ChangeLog.d/hbackup--mainline--0 rbackup.kakajou
     rbackup.lyonesse


2006-07-09 11:20:07 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-38

    Summary:
      --sftp-server option
    Revision:
      hbackup--mainline--0--patch-38

    * nhbackup.cc: --sftp-server option.
    * sftp.cc: Implement --sftp-server option.
    * hbackup.1: Document --sftp-server.

    modified files:
     ChangeLog.d/hbackup--mainline--0 globals.cc hbackup.1
     nhbackup.cc nhbackup.h sftp.cc


2006-07-09 11:13:16 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-37

    Summary:
      Correct error message.
    Revision:
      hbackup--mainline--0--patch-37

    * sftp.cc: correct error message when rename fails.

    modified files:
     ChangeLog.d/hbackup--mainline--0 sftp.cc


2006-07-08 17:39:06 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-36

    Summary:
      Accept long SFTP replies
    Revision:
      hbackup--mainline--0--patch-36

    * file.cc: File::getbytes() will now try to read all the bytes requested
      unless you ask it to accept short reads.  Most callers do actually ask
      it not to, but the SFTP code in particular asks it to read everything.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc file.cc hash.cc
     nhbackup.h restore.cc sftp.cc


2006-07-08 17:23:42 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-35

    Summary:
      Correct writes
    Revision:
      hbackup--mainline--0--patch-35

    * sftp.cc: Update writeoffset when writing.  Doh!

    modified files:
     ChangeLog.d/hbackup--mainline--0 sftp.cc


2006-07-08 17:08:16 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-34

    Summary:
      Exception on broken url-encodeds strings
    Revision:
      hbackup--mainline--0--patch-34

    * utils.cc: Use at() rather than [] on unchecked string indexing.

    modified files:
     ChangeLog.d/hbackup--mainline--0 utils.cc


2006-07-08 17:06:06 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-33

    Summary:
      Cope with unknown UIDs/GIDs.
    Revision:
      hbackup--mainline--0--patch-33

    * utils.cc: Handle UIDs/GIDs not known to get*nam, and numeric UIDs/GIDs
      found in existing backups.

    modified files:
     ChangeLog.d/hbackup--mainline--0 utils.cc


2006-07-08 16:47:07 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-32

    Summary:
      Grotty workaround for MacOS insanity.
    Revision:
      hbackup--mainline--0--patch-32

    * backup.cc: Cope with files that readdir returns but lstat ENOENTs.  We
      just leave them out and issue a warning.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc


2006-07-08 16:26:33 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-31

    Summary:
      Partial SFTP support
    Revision:
      hbackup--mainline--0--patch-31

    Not working yet, but inconvenient to leave uncommited.
    
    * backup.cc: Index is on backupfs, not hostfs.
    
    * backup.kakajou: Use nhbackup.
    
    * file.cc: Flush writable files on destruction.  Default synchronize
      method (empty) called from flush().  New getbytes() base method.
      Default readlink/ismount throw ENOSYS.
    
    * local.cc: New readable() method uses select().  (SFTP connection is a
      LocalFile.)
    
    * hbackup.cc: --remote renamed to --sftp, which is now honored.  Ignore
      SIGPIPE.
    
    * nhbackup.h: File open modes are from an enum, not strings now.  New
      SftpFilesystem.
    
    * utils.cc: exitfn allows us to call _exit when we fatal() inside a fork.
    
    * sftp.cc: SFTP implementation.  Writes are broken.

    new files:
     sftp.cc

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile backup.cc
     backup.kakajou cleanup.cc exceptions.cc file.cc hash.cc
     local.cc nhbackup.cc nhbackup.h restore.cc utils.cc verify.cc


2006-06-11 10:24:56 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-30

    Summary:
      Administrivia
    Revision:
      hbackup--mainline--0--patch-30

    * Makefile: Install nhbackup.

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-06-10 15:30:26 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-29

    Summary:
      Administrivia
    Revision:
      hbackup--mainline--0--patch-29

    * Makefile: missing srcdir.

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile backup.sfere


2006-06-10 15:23:15 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-28

    Summary:
      Start of automated testing
    Revision:
      hbackup--mainline--0--patch-28

    * tests: Basic test script.

    new files:
     tests

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-06-10 15:05:29 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-27

    Summary:
      Linux build
    Revision:
      hbackup--mainline--0--patch-27

    * nhbackup.h: Missing <assert.h>

    modified files:
     ChangeLog.d/hbackup--mainline--0 nhbackup.h


2006-06-10 14:50:15 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-26

    Summary:
      Administrivia
    Revision:
      hbackup--mainline--0--patch-26

    * nhbackup.h: mark fatal() noreturn.
    * hash.cc: Quieten compiler.
    * Makefile: dist/distcheck targets.  Build with -O2 by default.  Separate
      install (useful to everybody) from install-local (mostly useful only to
      me).

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile TODO hash.cc
     nhbackup.h


2006-06-10 14:31:21 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-25

    Summary:
      Back up and restore sockets.
    Revision:
      hbackup--mainline--0--patch-25

    * backup.cc: Back up sockets.
    * restore.cc: Restore sockets (to local filesystems).
    * nhbackup.cc: Report number of sockets.
    
    * hbackup.1: Sockets are now backed and restore up by nhbackup.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc globals.cc
     hbackup.1 nhbackup.cc nhbackup.h restore.cc


2006-06-10 14:10:46 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-24

    Summary:
      Implement --verify.  Better docs.  --detect-bogus option.
    Revision:
      hbackup--mainline--0--patch-24

    * verify.cc: Implement --verify.
    * cleanup.cc: use getdetail().  Honor --detect-bogus.
    * nhbackup.cc: --detect-bogus option.  --cleanup rejects --index.
    * restore.cc: Shift getdetail() to utils.cc.
    * utils.cc: Shift getdetail() from restore.cc.
    
    * hbackup.1: Document nhbackup too.

    modified files:
     ChangeLog.d/hbackup--mainline--0 cleanup.cc globals.cc
     hbackup.1 nhbackup.cc nhbackup.h restore.cc utils.cc verify.cc


2006-06-10 12:19:13 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-23

    Summary:
      Implement --restore.
    Revision:
      hbackup--mainline--0--patch-23

    * restore.cc: Implement --restore.  Unlike the (current) Python script,
      directory mtimes should correct at the end.  It's currently a bit
      pickier about errors too.
    * exceptions.cc: BadHash becomes more general BadHex.
    * utils.cc: New functions error(), warning(), string2uid(), string2gid(),
      hexdecode().  Fix buffer size in hashpath().  BadHex instead of
      BadHash.
    * file.cc: New filesystem method link, mknod, lchown, chmod, symlink,
      utimes.  Default implementation reports ENOSYS.
    * local.cc: Local implementations of new filesystem methods.
    * cleanup.cc: Use error().

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.cc cleanup.cc
     exceptions.cc file.cc local.cc nhbackup.h restore.cc utils.cc


2006-06-04 20:43:59 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-22

    Summary:
      split up
    Revision:
      hbackup--mainline--0--patch-22

    Split up nhbackup into multiple source files.

    new files:
     backup.cc cleanup.cc exceptions.cc exclude.cc file.cc
     globals.cc hash.cc local.cc nhbackup.h restore.cc utils.cc
     verify.cc

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile nhbackup.cc


2006-06-04 16:25:04 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-21

    Summary:
      Reimplementation
    Revision:
      hbackup--mainline--0--patch-21

    * hbackup: support data= in restore.
    * nhbackup.cc: First drop of C++ reimplementation.  Not finished yet.

    new files:
     nhbackup.cc

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile hbackup


2006-05-22 18:14:13 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-20

    Summary:
      Fix overzealous --cleanup
    Revision:
      hbackup--mainline--0--patch-20

    * hbackup: --cleanup only visits sha1/ subdirectory, not whole repository!

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup


2006-03-06 22:40:43 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-19

    Summary:
      More work on kakajou backups
    Revision:
      hbackup--mainline--0--patch-19

    * backup.kakajou: Back up whole of /Users
    * rbackup.kakajou: Remote backups of kakajou to sfere

    new files:
     rbackup.kakajou

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.kakajou


2006-02-13 00:17:54 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-18

    Summary:
      fix Makefile
    Revision:
      hbackup--mainline--0--patch-18

    * Makefile (install): correct rbackup.* install

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-02-13 00:10:37 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-17

    Summary:
      More --no-rename documentation.
    Revision:
      hbackup--mainline--0--patch-17

    * hbackup.1: better advice about --no-rename post-crash procedure.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup.1


2006-02-13 00:01:44 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-16

    Summary:
      --cleanup verbosity
    Revision:
      hbackup--mainline--0--patch-16

    * hbackup: --cleanup --verbose writes progress reports to stderr.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup


2006-02-12 23:52:33 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-15

    Summary:
      Typos
    Revision:
      hbackup--mainline--0--patch-15

    "export" is spelt thusly.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.lyonesse
     rbackup.lyonesse


2006-02-12 23:45:18 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-14

    Summary:
      More --no-rename fixes.
    Revision:
      hbackup--mainline--0--patch-14

    * hbackup: only leave 'unsafe' marker if --no-rename, since that's what
      it's meant for.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup


2006-02-12 23:43:54 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-13

    Summary:
      --no-rename tidy-ups
    Revision:
      hbackup--mainline--0--patch-13

    * hbackup: Make sure repo exists before leaving flag files.  Attempt to
               clean up broken destinations when copying with --no-rename.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup


2006-02-12 22:22:00 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-12

    Summary:
      More remote backups
    Revision:
      hbackup--mainline--0--patch-12

    * Makefile: support for rbackup.* scripts
    * rbackup.lyonesse: Backup lyonesse onto sfere's external drive.
    * rbackup.sfere: Backup lyonesse onto sfere's external drive.

    new files:
     rbackup.lyonesse rbackup.sfere

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-02-12 22:07:57 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-11

    Summary:
      More SFTP backup work.
    Revision:
      hbackup--mainline--0--patch-11

    * hbackup: --no-rename option to work around the fact that SFTP can't
      rename on filesystems that don't have link() (and has trouble with
      overwrite rename in any case).  How rubbish.  See also Debian bug
      #352589.
    * hbackup.1: Document --no-rename.
    
    * hbackup.sh: Tools for SFTP backups.
    
    * backup.curator: Now curator has its own backup script which SFTPs to
      sfere.
    * backup.sfere: No longer back up curator from rsync'd copy.
    * backup.lyonesse: No longer back up curator from rsync'd copy.
    
    * Makefile: Remote install onto curator.

    new files:
     backup.curator

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile backup.lyonesse
     backup.sfere hbackup hbackup.1 hbackup.sh


2006-02-12 17:39:14 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-10

    Summary:
      SFTP support
    Revision:
      hbackup--mainline--0--patch-10

    * hbackup: Support remote repositories accessed by SFTP.
    
    * hbackup.1: Document --sftp.

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup hbackup.1


2006-02-02 18:26:26 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-9

    Summary:
      Documentation!
    Revision:
      hbackup--mainline--0--patch-9

    * hbackup.1: Man page for hbackup.

    new files:
     TODO hbackup.1

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-02-01 14:53:14 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-8

    Summary:
      kakajou re-arrangement
    Revision:
      hbackup--mainline--0--patch-8

    * backup.kakajou: We have /local instead of /usr/local now.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.kakajou


2006-01-28 18:06:18 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-7

    Summary:
      "Remote" backups
    Revision:
      hbackup--mainline--0--patch-7

    * hbackup.sh: Define directorie for other hosts
    * backup.sfere: Back up rsync copy of curator.  Would like to do the same
      for lyonesse and invenita....
    * backup.lyonesse: Back up rsync copy of curator and of sfere:/export

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.lyonesse backup.sfere
     hbackup.sh


2006-01-27 19:57:33 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-6

    Summary:
      New disk has arrived
    Revision:
      hbackup--mainline--0--patch-6

    * backup.sfere: Save music

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.sfere


2006-01-26 21:51:35 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-5

    Summary:
      Backups for sfere; --overwrite
    Revision:
      hbackup--mainline--0--patch-5

    * hbackup: Don't overwrite index files by default.  If you want to
      overwrite them then you must now specify the --overwrite option.  The
      idea is that if today's backup half-worked and you are now restarting
      it, you don't re-backup all the filesystems you already did.
    
    * hbackup.sh: Include $hostname in logical volume paths.
      Report each operation when backing up a snapshot.
    
    * backup.sfere: Backup script for sfere.  Things not done yet:
      - back up digital audio (too much)
      - snapshot /var (crashes!)

    new files:
     backup.sfere

    modified files:
     ChangeLog.d/hbackup--mainline--0 hbackup hbackup.sh


2006-01-15 15:12:44 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-4

    Summary:
      Support device files
    Revision:
      hbackup--mainline--0--patch-4

    * hbackup: Save and restore S_IFCHR and S_IFBLK files.  Sockets and FIFOs
      are still ignored for the time being.

    modified files:
     ChangeLog.d/hbackup--mainline--0 backup.lyonesse hbackup


2006-01-15 13:42:56 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-3

    Summary:
      De-unify after all
    Revision:
      hbackup--mainline--0--patch-3

    * backup.kakajou, backup.lyonesse: De-unify backup scripts
    * hbackup.sh: Common code for fragmented backup scripts

    new files:
     backup.kakajou backup.lyonesse hbackup.sh

    removed files:
     backup

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-01-14 19:38:24 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-2

    Summary:
      New driver script
    Revision:
      hbackup--mainline--0--patch-2

    * backup: Unified driver script

    new files:
     backup

    modified files:
     ChangeLog.d/hbackup--mainline--0 Makefile


2006-01-08 12:39:55 GMT	Richard Kettlewell <rjk@greenend.org.uk>	patch-1

    Summary:
      tidy up
    Revision:
      hbackup--mainline--0--patch-1

    * Makefile: add a makefile
    * ChangeLog.d/hbackup--mainline--0: add changelog

    new files:
     ChangeLog.d/.arch-ids/=id ChangeLog.d/hbackup--mainline--0
     Makefile

    new directories:
     ChangeLog.d ChangeLog.d/.arch-ids


2006-01-08 12:36:58 GMT	Richard Kettlewell <rjk@greenend.org.uk>	base-0

    Summary:
      initial import
    Revision:
      hbackup--mainline--0--base-0

    Initial import of hbackup into Arch.

    new files:
     hbackup


